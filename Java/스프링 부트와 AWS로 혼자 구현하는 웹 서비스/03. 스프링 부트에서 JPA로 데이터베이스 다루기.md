# 03. ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ JPAë¡œ ë°ì´í„°ë² ì´ìŠ¤ ë‹¤ë£¨ê¸°

- íŒ¨ëŸ¬ë‹¤ì„ ë¶ˆì¼ì¹˜
    - ê°ì²´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ì‹œ ë¬¸ì œ ë°œìƒ
    - ìƒì†, 1:N ê³¼ ê°™ì€ ê°ì²´ ëª¨ë¸ë§ì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ êµ¬í˜„ ë¶ˆê°€ â†’ ë°ì´í„° ë² ì´ìŠ¤ ëª¨ë¸ë§ì— ì§‘ì¤‘

## Spring Data JPA ì ìš©

### 1. Domain

```java
@Getter
@NoArgsConstructor
@Entity
public class Posts extends BaseTimeEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(length = 500, nullable = false)
    private String title;

    @Column(columnDefinition = "TEXT", nullable = false)
    private String content;

    private String author;

    @Builder
    public Posts(String title, String content, String author) {
        this.title = title;
        this.content = content;
        this.author = author;
    }

    public void update(String title, String content) {
        this.title = title;
        this.content = content;
    }
}
```

- @Entity
    - í…Œì´ë¸”ê³¼ ì—°ê²°ë  í´ë˜ìŠ¤

- @Id
    - í•´ë‹¹ í…Œì´ë¸”ì˜ PK

- @GeneratedValue
    - PKì˜ ìƒì„±ê·œì¹™

- @Column
    - í…Œì´ë¸”ì˜ ì¹¼ëŸ¼
    - ê¸°ë³¸ê°’ ì™¸ì— ì¶”ê°€ë¡œ ë³€ê²½ì´ í•„ìš”í•œ ì˜µì…˜ ì¡´ì¬ ì‹œ ì‚¬ìš©ã…Š

<aside>
ğŸ’¡ Entity í´ë˜ìŠ¤ì— Setter ë©”ì†Œë“œëŠ” ìƒì„± X

â†’ ìƒì„±ìë¥¼ í†µí•´ ê°’ì„ ìƒì„± / ë³€ê²½

â†’ ìƒì„±ìëŠ” @Builder í´ë˜ìŠ¤ ì‚¬ìš©

</aside>

### 2. Repository

```java
public interface PostsRepository extends JpaRepository<Posts, Long> {

}
```

- @Repository ë¶ˆí•„ìš”
- ë‹¨ìˆœ ì¸í„°í˜ì´ìŠ¤ ìƒì„±, JpaRepository<Entity í´ë˜ìŠ¤, PK íƒ€ì…>

## Spring Data JPA í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
@ExtendWith(SpringExtension.class)
@SpringBootTest
public class PostsRepositoryTest {

    @Autowired
    PostsRepository postsRepository;

    @AfterEach
    public void cleanup() {
        postsRepository.deleteAll();
    }

    @Test
    public void ê²Œì‹œê¸€ì €ì¥_ë¶ˆëŸ¬ì˜¤ê¸°() {
        //given
        String title = "í…ŒìŠ¤íŠ¸ ê²Œì‹œê¸€";
        String content = "í…ŒìŠ¤íŠ¸ ë³¸ë¬¸";

        postsRepository.save(Posts.builder()
                .title(title)
                .content(content)
                .author("jojoldu@gmail.com")
                .build());

        //when
        List<Posts> postsList = postsRepository.findAll();

        //then
        Posts posts = postsList.get(0);
        assertThat(posts.getTitle()).isEqualTo(title);
        assertThat(posts.getContent()).isEqualTo(content);
    }

    @Test
    public void BaseTimeEntity_ë“±ë¡() {
        //given
        LocalDateTime now = LocalDateTime.of(2019, 6, 4, 0, 0, 0);
        postsRepository.save(Posts.builder()
                .title("title")
                .content("content")
                .author("author")
                .build());
        //when
        List<Posts> postsList = postsRepository.findAll();

        //then
        Posts posts = postsList.get(0);

        System.out.println(">>>>>>>>> createDate=" + posts.getCreatedDate()
					+ ", 	modifiedDate=" + posts.getModifiedDate());

        assertThat(posts.getCreatedDate()).isAfter(now);
        assertThat(posts.getModifiedDate()).isAfter(now);
    }
}
```

- @AfterEach
    - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„ ìˆ˜í–‰ë˜ëŠ” ë©”ì†Œë“œ ì§€ì •
    - í…ŒìŠ¤íŠ¸ê°„ ë°ì´í„° ì¹¨ë²” ë§‰ê¸°

- postsRepository.save
    - posts í…Œì´ë¸”ì˜ idê°’ ì¡´ì¬ ìœ ë¬´ì— ë”°ë¼ì„œ insert/update ì¿¼ë¦¬ ì‹¤í–‰

- postsRepository.findAll
    - posts í…Œì´ë¸”ì— ìˆëŠ” ëª¨ë“  ë°ì´í„° ì¡°íšŒ

## ë“±ë¡/ìˆ˜ì •/ì¡°íšŒ API

- Web Layer
    - ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë·° í…œí”Œë¦¿ ì˜ì—­
    - ì™¸ë¶€ ìš”ì²­ê³¼ ì‘ë‹µ(í•„í„°, ì¸í„°ì…‰í„°, ì»¨íŠ¸ë¡¤ëŸ¬ ì–´ë“œë°”ì´ìŠ¤)ì— ëŒ€í•œ ì „ë°˜ì ì¸ ì˜ì—­
    
- Service Layer
    - Controllerì™€ Daoì˜ ì¤‘ê°„ ì˜ì—­
    - @Transactionalì´ ì‚¬ìš©ë˜ì–´ì•¼ í•˜ëŠ” ì˜ì—­

- Repository Layer
    - ë°ì´í„° ì €ì¥ì†Œì— ì ‘ê·¼í•˜ëŠ” ì˜ì—­

- Dtos
    - ê³„ì¸µ ê°„ì— ë°ì´í„° êµí™˜ì„ ìœ„í•œ ê°ì²´

  

- Domain Model
    - ë„ë©”ì¸ì„ ëª¨ë“  ì‚¬ëŒì´ ë™ì¼í•œ ê´€ì ì—ì„œ ì´í•´í•  ìˆ˜ ìˆê³  ê³µìœ í•  ìˆ˜ ìˆë„ë¡ ë‹¨ìˆœí™” ì‹œí‚¨ ê²ƒ
    - EX. ì¿ í° â†’ ì¿ í°ëª…, í• ì¸ìœ¨, ë§Œë£Œê¸°ê°„, ì‚¬ìš©ì¼ì

<aside>
â¡ï¸ ì„œë¹„ìŠ¤ : íŠ¸ëœì­ì…˜ê³¼ ë„ë©”ì¸ ê°„ì˜ ìˆœì„œë³´ì¥

<aside>
â¡ï¸ ê°ì²´ : ë‹¨ìˆœíˆ ë°ì´í„° ë©ì–´ë¦¬

</aside>

</aside>

### ìŠ¤í”„ë§ì—ì„œ Beanì„ ì£¼ì…ë°›ëŠ” ë°©ì‹

1. @Autowired
2. setter
3. ìƒì„±ì ğŸ‘
    
    ```
    (ë¡¬ë³µ) @RequiredArgsConstructor 
    â‡’ finalì´ ì„ ì–¸ëœ ëª¨ë“  í•„ë“œë¥¼ ì¸ìê°’ìœ¼ë¡œ í•˜ëŠ” ìƒì„±ìë¥¼ ìƒì„±
    
    ì‚¬ìš©ì´ìœ 
    â‡’ ìƒì„±ìë¥¼ ì§ì ‘ ìƒì„±ì‹œ
    		í•´ë‹¹ í´ë˜ìŠ¤ì˜ ì˜ì¡´ì„± ê´€ê³„ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤
    		ìƒì„±ì ì½”ë“œë¥¼ ê³„ì†í•´ì„œ ìˆ˜ì •í•´ì•¼ë˜ëŠ” ë²ˆê±°ë¡œì›€ì„ í•´ê²°í•˜ê¸° ìœ„í•¨ 
    ```
    

Entityí´ë˜ìŠ¤ì™€ ìœ ì‚¬í•œ í˜•íƒœì˜ Dto í´ë˜ìŠ¤ ì¶”ê°€ ìƒì„±

ex. ~~RequestDto

â‡’ Entity í´ë˜ìŠ¤ ìì²´ë¥¼ Request/Response í´ë˜ìŠ¤ë¡œ ì‚¬ìš© âŒ

â‡’ Entity í´ë˜ìŠ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì™€ ë§ë‹¿ì€ í•µì‹¬ í´ë˜ìŠ¤ë¡œ ìˆ˜ë§ì€ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë‚˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë™ì‘ê¸°ì¤€ì´ê¸° ë–„ë¬¸

## JPA Auditing : ìƒì„±ì‹œê°„/ìˆ˜ì •ì‹œê°„ ìë™í™”

### LocalDate ì‚¬ìš©

- ìŠ¤í”„ë§ë¶€íŠ¸ ë²„ì „
    - 1.x - Hibernate 5.2.10ë²„ì „ ì´ìƒ ì‚¬ìš©
    - 2.x - ë°”ë¡œì ìš©

- BaseTimeEntity
    - ëª¨ë“  Entityì˜ ìƒìœ„ í´ë˜ìŠ¤, Entityë“¤ì˜ Dateë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì—­í• 
    - ì†ŒìŠ¤ì½”ë“œ
        
        ```java
        import lombok.Getter;
        import org.springframework.data.annotation.CreatedDate;
        import org.springframework.data.annotation.LastModifiedDate;
        import org.springframework.data.jpa.domain.support.AuditingEntityListener;
        
        import javax.persistence.EntityListeners;
        import javax.persistence.MappedSuperclass;
        import java.time.LocalDateTime;
        
        @Getter
        @MappedSuperclass //BaseTimeEntity ìƒì†ì‹œ í•´ë‹¹ Entityê°€ í•„ë“œë“¤ë„ ì»¬ëŸ¼ìœ¼ë¡œ ì¸ì‹
        @EntityListeners(AuditingEntityListener.class) //Auditing ê¸°ëŠ¥ ì¶”ê°€
        public abstract class BaseTimeEntity {
        
            @CreatedDate //ì—”í‹°í‹° ìƒì„±í›„ ì €ì¥ -> ì‹œê°„ ìë™ ì €ì¥
            private LocalDateTime createdDate;
        
            @LastModifiedDate //ì—”í‹°í‹° ë³€ê²½ -> ì‹œê°„ ìë™ ì €ì¥
            private LocalDateTime modifiedDate;
        
        }
        ```
        
    - ì¶”ê°€ ì„¤ì •
        
        ```java
        @EnableJpaAuditing // JPA Auditing í™œì„±í™”
        @SpringBootApplication
        public class Application {
            public static void main(String[] args) {
                SpringApplication.run(Application.class, args);
            }
        }
        ```
        
    - í…ŒìŠ¤íŠ¸ ì½”ë“œ
        
        ```java
        @Test
        public void BaseTimeEntity_ë“±ë¡() {
        	//given
        	LocalDateTime now = LocalDateTime.of(2019, 6, 4, 0, 0, 0);
        	postsRepository.save(Posts.builder()
        		.title("title")
        		.content("content")
        		.author("author")
        		.build());
        
        	//when
        	List<Posts> postsList = postsRepository.findAll();
        	
        	//then
        	Posts posts = postsList.get(0);
        	
        	System.out.println(">>>>>>>>> createDate=" + posts.getCreatedDate() 
        		+ ", modifiedDate=" + posts.getModifiedDate());
        	
        	assertThat(posts.getCreatedDate()).isAfter(now);
        	assertThat(posts.getModifiedDate()).isAfter(now);
        }
        ```
